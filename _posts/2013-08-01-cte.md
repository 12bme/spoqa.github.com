---
layout: entry
title: CTE for postgresql
author: 박수철
author-email: douglas@spoqa.com
description: postgresql의 CTE 를 살펴봅니다.
---

## CTE란?
- Common table expression 의 약자로 '공통 테이블 식' 입니다.

## CTE의 특징
- WITH절 같은 SELECT 문에서 효과적으로 테이블 식을 정의 할 수 있습니다.
- CTE는 VIEW의 사용방법과 비슷하지만, VIEW보다 편리합니다.
- VIEW와 달리 사전에 CTE를 정의할 필요는 없습니다.
- CTE는 재귀 쿼리를 사용할 수 있습니다. 

## 재귀 CTE 예제

 재귀 쿼리를 사용하려면 RECURSIVE 키워드를 추가해야 합니다. 아래는 WITH RECURSIVE 사용에 대한 예제입니다.  

Table “department” 인접 리스트로 조직 구조를 나타냅니다.

<script src="https://gist.github.com/masterguru9/6130374.js"></script>
     
![screen](/images/2013-08-01/table_ex1.png)

부서 구조:

	ROOT-+->A-+->B-+->C
	     |         |
	     |         +->D-+->F
	     +->E-+->G



A의 하위 부서를 추출, 다음과 같은 재귀 쿼리를 사용할 수 있습니다.

<script src="https://gist.github.com/masterguru9/0affc843bd6ad4c7e5d6.js"></script>

위의 쿼리는 다음과 같이 설명할 수 있습니다.

중간 테이블(Intermediate table), 작업 테이블(work table), 결과 테이블(result table)이 있습니다.

1. 초기화
	1. 비재귀 구간을 실행 (SELECT * FROM department WHERE name = ‘A’)  
	2. ResultTable = WorkTable = ('A') 결과 테이블과 작업 테이블에 결과를 배치합니다.  
	3. IntermediateTable = () 중간 테이블을 비웁니다.
2. 재귀 쿼리 실행
	1. (SELECT d.* FROM WT AS d JOIN subdepartment AS sd ON d.parent_department = sd.id)
	 하위 부서와 작업 테이블을 바꾸고, 재귀 구간을 실행합니다.
	2. 중간 테이블에 쿼리 결과를 할당합니다.
	3. 결과 테이블 및 작업테이블에 중간테이블 추가합니다.
	4. 중간 테이블을 비웁니다.
3. 재귀가 끝났는지 확인
	1. 2번 과정의 중간테이블이 비어 있으면 재귀의 실행이 종료되고, 결과 테이블은 반환됩니다.
	2. 중간테이블이 비어 있지 않으면 다시 2번의 과정으로 돌아갑니다.
	
"subdepartment"는 재귀 표현을 포함하고 있는 CTE입니다. 먼저 비재귀항이 평가되고, 다음 재귀항이 평가됩니다. 재귀항은 평가하고 처리하는 데이터가 없을 때까지 결과가 반복적으로 이전 결과에 추가됩니다. 끝으로 마지막 SELECT가 실행되고 데이터는 결과 집합에서 추출됩니다.

## CTE의 한계점

- SEARCH 및 CYCLE 절은 구현되지 않습니다.
- 상호 재귀는 허용되지 않습니다.
- UNION ALL의 마지막 SELECT 만 재귀 이름을 포함 할 수 있습니다.
- 재귀와 재귀스캔(RecursiveScan) 계획의 비용은 항상 0입니다

----
원문	[CTEReadme](http://wiki.postgresql.org/wiki/CTEReadme)

