---
layout: entry
title: CTE for postgresql and sqlalchemy
author: 박수철
author-email: douglas@spoqa.com
description: postgresql의 CTE와 sqlalchemy로 변환 예를 살펴봅니다.
---

## CTE란?
- [Common table expression](http://en.wikipedia.org/wiki/Common_table_expression#Common_table_expression) 의 약자로 '공통 테이블 식'입니다.

## CTE 특징
- WITH절 같은 SELECT 문에서 효과적으로 테이블 식을 정의 할 수 있습니다.
- CTE는 VIEW의 사용방법과 비슷하지만, VIEW보다 편리합니다.
- VIEW와 달리 사전에 CTE를 정의할 필요가 없습니다.
- 개체로 저장 되지 않고, 쿼리 지속시간에만 존재합니다.
- CTE는 재귀 쿼리를 사용할 수 있습니다.
- 재귀 CTE는 여러행을 반환 가능합니다.
- 동일 문에서 결과 테이블을 여러번 참조 가능합니다.

## 재귀 CTE 예제

아래 예제는 'A'부서 하위에 있는 부서만 추출하는 예제입니다.

일단 재귀 CTE를 이용한 쿼리를 사용하려면 'WITH RECURSIVE' 키워드를 추가해야 합니다.

Table 'department' 인접 리스트로 조직 구조를 나타냅니다.

<script src="https://gist.github.com/masterguru9/6130374.js"></script>

![screen](/images/2013-08-01/table_ex1.png)

부서 구조:

	ROOT-+->A-+->B-+->C
	     |         |
	     |         +->D-+->F
	     +->E-+->G


A의 하위 부서를 추출, 다음과 같은 재귀 쿼리를 사용할 수 있습니다.

<script src="https://gist.github.com/masterguru9/0affc843bd6ad4c7e5d6.js"></script>

위의 쿼리는 다음과 같이 설명할 수 있습니다.

중간 테이블(Intermediate table), 작업 테이블(work table), 결과 테이블(result table)이 있습니다.

1. 초기화
	1. 비재귀 구간을 실행 (SELECT * FROM department WHERE name = ‘A’)  
	2. ResultTable = WorkTable = ('A') 결과 테이블과 작업 테이블에 결과를 배치합니다.  
	3. IntermediateTable = () 중간 테이블을 비웁니다.
2. 재귀 쿼리 실행
	1. (SELECT d.* FROM WT AS d JOIN subdepartment AS sd ON d.parent_department = sd.id)
	 하위 부서와 작업 테이블을 바꾸고, 재귀 구간을 실행합니다.
	2. 중간 테이블에 쿼리 결과를 할당합니다.
	3. 결과 테이블 및 작업테이블에 중간테이블 추가합니다.
	4. 중간 테이블을 비웁니다.
3. 재귀가 끝났는지 확인
	1. 2번 과정의 중간테이블이 비어 있으면 재귀의 실행이 종료되고, 결과 테이블은 반환됩니다.
	2. 중간테이블이 비어 있지 않으면 다시 2번의 과정으로 돌아갑니다.
	
"subdepartment"는 재귀 표현을 포함하고 있는 CTE입니다. 먼저 비재귀항이 평가되고, 다음 재귀항이 평가됩니다. 재귀항은 평가하고 처리하는 데이터가 없을 때까지 결과가 반복적으로 이전 결과에 추가됩니다. 끝으로 마지막 SELECT가 실행되고 데이터는 결과 집합에서 추출됩니다.

## CTE의 한계점

- SEARCH 및 CYCLE 절은 구현되지 않습니다.
- 상호 재귀는 허용되지 않습니다.
- UNION ALL의 마지막 SELECT 만 재귀 이름을 포함 할 수 있습니다.
- 재귀와 재귀스캔(RecursiveScan) 계획의 비용은 항상 0입니다

## slqalchemy 란?
[SQLAlchemy](http://www.sqlalchemy.org/)는 파이썬에서 이용할 수 있는 [ORM](http://en.wikipedia.org/wiki/Object-relational_mapping) 입니다.

## sqlalchemy 로 변환

앞서 봤던 예제를 [sqlalchemy core](http://docs.sqlalchemy.org/en/rel_0_8/core/)로 옮기면 아래와 같은 형태가 됩니다.

<script src="https://gist.github.com/masterguru9/6154228.js"></script>

1. department 테이블을 정의합니다.
2. WITH 절부터 시작되는 CTE 부분의 비재귀항을 subdepartment로 만듭니다.  재귀 사용을 위해 <b>.cte( recursive=True)</b> 부분을 붙여줍니다.
3. department 와 subdepartment 에 각각 alias를 붙여줍니다.
4. CTE 부분의 재귀항과 비재귀 항을 union all 해주는 subdepartment를 만듭니다. (이 부분이 위 쿼리에서 봤던 WITH RECURSIVE subdepartment 전체를 나타내는 부분이라 할 수 있습니다.)
5. 마지막으로 결과 쿼리를 출력하기 위한 statement를 만듭니다.


## 마무리 하며
CTE에 관한 글을 적은 이유는 아무래도 일을 하다보니 사용할 일이 생겨서 입니다. 쿼리를 재귀로 돌릴 수 있고, 사용하기가 더 쉽다는 말에 혹 했는데.. 원문을 줄여서 옮기고, sqlalchemy 부분을 살짝 추가하면서 든 생각은 "내가 제대로 이해를 못하고 있구나!" 와 "왜 이 주제를 선택했지 했나!" 입니다. 

특히 sqlalchemy 는 여전히 미숙하게 사용하고 있는데 바꾸려니 삽질을 많이 했던 거 같습니다. sqlalchemy로 바꾸면서 드는 생각은 쿼리가 복잡하면 같은 결과가 나오는 좀 더 단순한 쿼리로 바꾼 다음 sqlahchemy로 변환시키는 게 쉬운거 같습니다. (join을 제대로 바꾸지 못해서 where절로 바꿔서 진행한..)

그럼 많은 테클 바라며 이만 글을 줄이겠습니다.

----
원문: [CTEReadme](http://wiki.postgresql.org/wiki/CTEReadme)

참조:  [공통 테이블 식 사용](http://msdn.microsoft.com/ko-kr/library/ms190766) ,[공통 테이블 식을 사용하는 재귀 쿼리](http://msdn.microsoft.com/ko-kr/library/ms186243)


