---
layout: entry
title: 도도테이블 101
author: 강효준
author-email: ed@spoqa.com
description: 사내에서 만들어 사용중인 라이브러리, 도도 테이블에 대해 소개합니다.
publish: true
---

[도도 테이블][dodotable]은 [SQAlchemy][]에서 검색해온 결과를 HTML `<table>`로 쉽게 보여주는 파이썬 라이브러리입니다. 도도 테이블을 만들게된 이유와 사용법을 간단하게 소개하려고합니다.


## 도도 테이블을 만든 이유

[도도 인사이트][dodo-insight]는 도도 포인트를 이용하는 점주들이 자신의 매장에서 적립한 손님들의 데이터를 통해 통찰(insight)을 얻을 수 있도록 도와주는 제품일 뿐만 아니라, 스포카 사내에서 [SP팀][spoqa-sp]과 [PC팀][spoqa-pc]에서 매장을 쉽게 관리하도록 도와주는 [CRM][] 서비스이기도합니다.

그렇기때문에 도도 인사이트는 적립/사용 결과를 요약하여 보여주는 분석 기능이외에도 고객 목록, 매장/브랜드 목록, 적립/사용 기록 같이 테이블의 형태로 보여주는 것이 적합한 정보들도 많이 제공하고있습니다. 따라서 도도 인사이트 서버에 저장된 기록들을 가공하여 `<table>`의 형태로 보여주는 일이 빈번하게 일어나고, 이를 위한 라이브러리가 필요한 상태였습니다.


### URL은 보존되어야 한다

`<table>`을 보여주기위해서 도도 테이블이 만들어지기전에 사내에서 주로 사용하던 라이브러리는 [datatable][]이었습니다. datatable은 여러 데이터 소스(DOM, JavaScript, Ajax 등)를 지원하는 jQuery 플러그인입니다. 도도 인사이트에서는 Ajax를 이용해 비동기 통신으로 데이터를 얻어오도록했는데, 그래서 페이지 이동, 검색, 필터링 등의 기능이 있지만 웹브라우저의 URL은 변경되지않고 하나로 고정되어보여집니다.[^1]

비동기 통신인만큼 웹페이지 전체 로딩을 하지않고 그만큼 로딩시간을 단축시킬 수 있다는 장점도 있지만, 다음의 단점들이 있습니다.

첫번째, 브라우저의 뒤로가기 혹은 앞으로 가기 버튼을 사용하지 못합니다. 웹브라우저는 URL을 이용하여 리소스의 위치를 얻어오므로 보여지는 리소스가 변경되었을때 URL이 변하지않는다면 웹브라우저의 고유기능인 뒤로/앞으로 가기를 사용하지 못하게됩니다.

두번째, 내부팀 혹은 매장에서 특정 페이지의 정보를 공유받을때 스크린샷 혹은 구두로 리소스의 위치를 전달받을 수 밖에 없습니다. 도도 포인트는 매장과 손님의 관계를 이어주는 서비스인만큼 손님의 포인트 적립/사용 정보, 잔여 포인트, 손님이 받은 쿠폰 등이 중요하고 이를 확인해야하는 상황도 빈번하게 발생합니다. 이럴때 다음과 같은 정보를 URL없이 전달한다면 어떨까요?

- A매장이 손님 목록을
- 최근 방문 일시로 올림차순 정렬후에
- 남자 손님으로 필터링하고
- 네번째 페이지, 7번째줄

만약에 기능 버그나 손님의 정보에 문제가 있어 이슈까지 생성해야한다면 조금은 고통스러운 상황입니다.


### SQLAlchemy 모델 구조와 테이블 구조를 활용하도록

스포카에서는 많은 서비스와 제품들이 Python으로 작성되어있고 SQLAlchemy도 적극적으로 이용하고 있습니다. 그런데 jQuery 플러그인인 datatable에서 비동기 통신을 통해 정보를 가져오게 하기위해서는 정보를 가지고올 API를 작성하는 일도 필요합니다. 

이런 API에서 복잡한 로직을 작성해야하는 일은 드물지만, 모든 HTTP API가 비슷하듯 반복되는 패턴이 있습니다.

- HTTP 요청에 querystring 혹은 body 로부터 여러 조건을 전달 받습니다.
  - 어떤 페이지를 가지고올것인가?
  - 정렬은 어떻게 할 것인가?
  - 어떤 단어를 검색하고 싶은가?
- 이 조건들을 해석하고 데이터를 저장하고 있는 매체(캐시 레이어, 데이터베이스 등등)에 필요한 정보를 가지고 오도록 요청합니다.
- 가지고온 데이터는 리소스 요청한 클라이언트에서 사용할 수 있도록 직렬화하여 응답합니다. 스포카에서는 주로 JSON을 사용합니다.

API의 핵심적인 로직은 저장 매체에 정보를 갖고오도록 하는 부분임에도 불구하고 가장 많은 시간은 조건들을 어떻게 해석할 것이며(deserialize 또는 parsing) 이를 요청하는 쪽에 전달할 수 있는 형태로 바꾸는데(serialize) 많은 시간을 소요하게됩니다. 이런 작업들을 데이터의 구조(schema)를 빼고보면 어느정도 일반화 할 수 있는 부분입니다.

또한 핵심적인 로직인 어떤 정보를 어떤 조건으로 얼마만큼 가지고오는지도 데이터를 테이블로 보여주어야하는 경우, 테이블이 보여지는 모습이 직접적으로 로직에 관여하게 됩니다.

이런 조건들 안에서 jQuery 플러그인 datatable을 사용한다면, 웹브라우저 안에서 실행되어야하므로 서버안에서 정의된 SQAlchemy의 구조를 활용하지뿐만 아니라 비슷하지만 일반화시키지 못하는 부분이 반복해서 생길수 밖에 없습니다.

## 도도 테이블 사용하기

도도 테이블은 [문서 맨 앞][dodotable-readme]에 써있는 것처럼 SQLAlchemy 쿼리 결과를 HTML로 나타내는 도구입니다. 도도 테이블을 구현하면서 위에 언급했던 문제들을 어떻게 풀어냈는지 설명해보려고합니다.

### `<table>`와 Python 코드를 비슷하게 맞추기

HTML에서 테이블 태그를 작성할때는,

```html
<table>
  <thead>
    <tr>
      <th>컬럼 이름</th>
    </tr>
  </thead>
</table>
```

[SQAlchemy]: http://docs.sqlalchemy.org/
[dodotable]: https://github.com/spoqa/dodotable
[dodo-insight]: https://dodoinsight.com
[spoqa-sp]: http://www.spoqa.com/enabler/
[spoqa-pc]: http://www.spoqa.com/enabler/
[CRM]: https://wikipedia
[datatable]: https://datatables.net/
[dodotable-readme]: https://github.com/spoqa/dodotable/blob/master/README.rst
[^1]: history.pushState 를 이용해서 조작할 수는 있겠지만 그런 기능을 구현하진않았습니다. https://developer.mozilla.org/en-US/docs/Web/API/History_API
